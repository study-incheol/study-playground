# 1.13. Environment Abstraction

> [1.13. Environment Abstraction](https://docs.spring.io/spring-framework/docs/current/reference/html/core.html#beans-environment) ì±•í„°ë¥¼ ìš”ì•½í•œ ë‚´ìš©ì…ë‹ˆë‹¤.

[Enviroment](https://docs.spring.io/spring-framework/docs/5.3.23/javadoc-api/org/springframework/core/env/Environment.html) ì¸í„°í˜ì´ìŠ¤ëŠ” ì• í”Œë¦¬ì¼€ì´ì…˜ í™˜ê²½ì˜ ë‘ ê°€ì§€ ì£¼ìš” ì¸¡ë©´ì¸ [profiles](https://docs.spring.io/spring-framework/docs/current/reference/html/core.html#beans-definition-profiles) ê³¼ [properties](https://docs.spring.io/spring-framework/docs/current/reference/html/core.html#beans-property-source-abstraction) ë¥¼ ëª¨ë¸ë§í•˜ëŠ” ì»¨í…Œì´ë„ˆì— í†µí•©ëœ ì¶”ìƒí™”ì´ë‹¤.

í”„ë¡œí•„ì€ ì§€ì •ëœ í”„ë¡œí•„ì´ í™œì„±í™”ëœ ê²½ìš°ì—ë§Œ ì»¨í…Œì´ë„ˆì— ë“±ë¡ë˜ëŠ” ì´ë¦„ì´ ì§€ì •ëœ ë…¼ë¦¬ì  Bean ì •ì˜ ê·¸ë£¹ì´ë‹¤. Beanì€ XMLë¡œ ì •ì˜ë˜ê±°ë‚˜ ì–´ë…¸í…Œì´ì…˜ìœ¼ë¡œ ì •ì˜ë˜ëŠ”ì§€ ì—¬ë¶€ì— ê´€ê³„ì—†ì´ í”„ë¡œí•„ì— í• ë‹¹ë  ìˆ˜ ìˆë‹¤. í”„ë¡œí•„ê³¼ ê´€ë ¨ëœ `Environment` ì˜¤ë¸Œì íŠ¸ì˜ ì—­í• ì€ í˜„ì¬ í™œì„±í™”ëœ í”„ë¡œí•„(ìˆëŠ” ê²½ìš°)ê³¼ ê¸°ë³¸ì ìœ¼ë¡œ í™œì„±í™”ë˜ì–´ì•¼ í•˜ëŠ”(default) í”„ë¡œí•„(ìˆëŠ” ê²½ìš°)ì„ ê²°ì •í•˜ëŠ” ê²ƒì´ë‹¤.

í”„ë¡œí¼í‹°ëŠ” ê±°ì˜ ëª¨ë“  ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ ì¤‘ìš”í•œ ì—­í• ì„ í•˜ë©° í”„ë¡œí¼í‹° íŒŒì¼, JVM ì‹œìŠ¤í…œ ì†ì„±, ì‹œìŠ¤í…œ í™˜ê²½ ë³€ìˆ˜, JNDI, ì„œë¸”ë¦¿ ì»¨í…ìŠ¤íŠ¸ ë§¤ê°œ ë³€ìˆ˜, ì• ë“œí˜¹ `Properties` ì˜¤ë¸Œì íŠ¸, `Map` ê°ì²´ ë“±ê³¼ ê°™ì€ ë‹¤ì–‘í•œ ì†ŒìŠ¤ì—ì„œ ë¹„ë¡¯ë  ìˆ˜ ìˆë‹¤. í”„ë¡œí¼í‹°ì™€ ê´€ë ¨ëœ `Environment` ê°ì²´ì˜ ì—­í• ì€ í”„ë¡œí¼í‹° ì†ŒìŠ¤ë¥¼ êµ¬ì„±í•˜ê³  í”„ë¡œí¼í‹°ë“¤ ì†ì—ì„œ í”„ë¡œí¼í‹°ë¥¼ ì—°ê²°í•˜ê¸° ìœ„í•œ í¸ë¦¬í•œ ì„œë¹„ìŠ¤ ì¸í„°í˜ì´ìŠ¤ë¥¼ ì‚¬ìš©ìì—ê²Œ ì œê³µí•˜ëŠ” ê²ƒì´ë‹¤.

## 1.13.1. Bean Definition Profiles

Bean ì •ì˜ í”„ë¡œí•„ì€ ì„œë¡œ ë‹¤ë¥¸ í™˜ê²½ì—ì„œ ì„œë¡œ ë‹¤ë¥¸ Beanì„ ë“±ë¡í•  ìˆ˜ ìˆë„ë¡ í•˜ëŠ” ë©”ì»¤ë‹ˆì¦˜ì„ ì½”ì–´ ì»¨í…Œì´ë„ˆì— ì œê³µí•œë‹¤. "í™˜ê²½"ì´ë¼ëŠ” ë‹¨ì–´ëŠ” ì‚¬ìš©ìì— ë”°ë¼ ë‹¤ë¥¸ ì˜ë¯¸ë¥¼ ê°€ì§ˆ ìˆ˜ ìˆìœ¼ë©° ì´ ê¸°ëŠ¥ì€ ë‹¤ìŒì„ í¬í•¨í•œ ë§ì€ ì‚¬ìš© ì‚¬ë¡€ì— ë„ì›€ì´ ë  ìˆ˜ ìˆë‹¤.

- ê°œë°œ ì¤‘ì¸ ë©”ëª¨ë¦¬ ë‚´ ë°ì´í„° ì†ŒìŠ¤ì— ëŒ€í•´ ì‘ì—…í•˜ëŠ” ê²ƒê³¼ QA ë˜ëŠ” ìš´ì˜ì— ìˆì„ ë•Œ JNDIì—ì„œ ë™ì¼í•œ ë°ì´í„° ì†ŒìŠ¤ë¥¼ ì°¾ëŠ” ê²ƒ.

- ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ì„±ëŠ¥ í™˜ê²½ì— ë°°í¬í•  ë•Œë§Œ ëª¨ë‹ˆí„°ë§ ì¸í”„ë¼ë¥¼ ë“±ë¡í•œë‹¤.

- ê³ ê° A ì™€ ê³ ê° B ë°°í¬ì— ëŒ€í•œ Beanì˜ ì‚¬ìš©ì ì •ì˜ êµ¬í˜„ì„ ë“±ë¡í•œë‹¤.

`DataSource`ê°€ í•„ìš”í•œ ì‹¤ì œ ì‘ìš© í”„ë¡œê·¸ë¨ì˜ ì²« ë²ˆì§¸ ì‚¬ìš© ì‚¬ë¡€ë¥¼ ë³´ì. í…ŒìŠ¤íŠ¸ í™˜ê²½ì—ì„œ êµ¬ì„±ì€ ë‹¤ìŒê³¼ ìœ ì‚¬í•  ìˆ˜ ìˆë‹¤.

```java
@Bean
public DataSource dataSource() {
	return new EmbeddedDatabaseBuilder()
	.setType(EmbeddedDatabaseType.HSQL)
	.addScript("my-schema.sql")
	.addScript("my-test-data.sql")
	.build();
}
```

ì´ì œ ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ë°ì´í„° ì†ŒìŠ¤ê°€ ìš´ì˜ ì• í”Œë¦¬ì¼€ì´ì…˜ ì„œë²„ì˜ JNDI ë””ë ‰í† ë¦¬ì— ë“±ë¡ë˜ì–´ ìˆë‹¤ê³  ê°€ì •í•˜ê³  ì´ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ QA ë˜ëŠ” ìš´ì˜ í™˜ê²½ì— ë°°í¬í•˜ëŠ” ë°©ë²•ì„ ìƒê°í•´ë³´ì. ì´ì œ `dataSource` ë¹ˆì€ ë‹¤ìŒ ëª©ë¡ê³¼ ê°™ë‹¤.

```java
@Bean(destroyMethod="")
public DataSource dataSource() throws Exception {
	Context ctx = new InitialContext();
	return (DataSource) ctx.lookup("java:comp/env/jdbc/datasource");
}
```

ë¬¸ì œëŠ” í˜„ì¬ í™˜ê²½ì— ë”°ë¼ ì´ ë‘ ê°€ì§€ ë³€í˜•ì„ ì‚¬ìš©í•˜ëŠ” ë°©ë²•ì„ ì „í™˜í•˜ëŠ” ê²ƒì´ë‹¤. ì‹œê°„ì´ ì§€ë‚¨ì— ë”°ë¼ Spring ì‚¬ìš©ìëŠ” ì‹œìŠ¤í…œ í™˜ê²½ ë³€ìˆ˜ì™€ í™˜ê²½ ë³€ìˆ˜ì˜ ê°’ì— ë”°ë¼ ì˜¬ë°”ë¥¸ êµ¬ì„± íŒŒì¼ ê²½ë¡œë¡œ í™•ì¸ë˜ëŠ” `${placeholder}` í† í°ì„ í¬í•¨í•˜ëŠ” XML `<import/>` ë¬¸ì˜ ì¡°í•©ì— ì˜ì¡´í•˜ì—¬ ì´ë¥¼ ìˆ˜í–‰í•˜ëŠ” ì—¬ëŸ¬ ê°€ì§€ ë°©ë²•ì„ ê³ ì•ˆí–ˆë‹¤. Bean ì •ì˜ í”„ë¡œí•„ì€ ì´ ë¬¸ì œì— ëŒ€í•œ ì†”ë£¨ì…˜ì„ ì œê³µí•˜ëŠ” ì½”ì–´ ì»¨í…Œì´ë„ˆ ê¸°ëŠ¥ì´ë‹¤.

í™˜ê²½ë³„ ë¹ˆ ì •ì˜ì˜ ì´ì „ ì˜ˆì œì—ì„œ ë³´ì—¬ì§„ ì‚¬ìš© ì‚¬ë¡€ë¥¼ ì¼ë°˜í™”í•˜ë©´ ê²°êµ­ íŠ¹ì • ì»¨í…ìŠ¤íŠ¸ì—ì„œëŠ” íŠ¹ì • ë¹ˆ ì •ì˜ë¥¼ ë“±ë¡í•´ì•¼ í•˜ì§€ë§Œ ë‹¤ë¥¸ ì»¨í…ìŠ¤íŠ¸ì—ì„œëŠ” ë“±ë¡í•˜ì§€ ì•Šì•„ë„ ëœë‹¤. ìƒí™© Aì—ì„œ ë¹ˆ ì •ì˜ì˜ íŠ¹ì • í”„ë¡œí•„ì„ ë“±ë¡í•˜ê³  ìƒí™© Bì—ì„œ ë‹¤ë¥¸ í”„ë¡œí•„ì„ ë“±ë¡í•˜ê³  ì‹¶ë‹¤ê³  ë§í•  ìˆ˜ ìˆë‹¤. ìš°ë¦¬ëŠ” ì´ëŸ¬í•œ ìš”êµ¬ê°€ ë°˜ì˜í•˜ë„ë¡ êµ¬ì„±ì„ ì—…ë°ì´íŠ¸í•˜ëŠ” ê²ƒìœ¼ë¡œ ì‹œì‘í•œë‹¤.

### @Profile ì‚¬ìš©

[`@Profile`](https://docs.spring.io/spring-framework/docs/5.3.23/javadoc-api/org/springframework/context/annotation/Profile.html) ì–´ë…¸í…Œì´ì…˜ì„ ì‚¬ìš©í•˜ë©´ í•˜ë‚˜ ì´ìƒì˜ ì§€ì •ëœ í”„ë¡œí•„ì´ í™œì„±í™”ë  ë•Œ êµ¬ì„± ìš”ì†Œê°€ ë“±ë¡ì— ì í•©í•¨ì„ ë‚˜íƒ€ë‚¼ ìˆ˜ ìˆë‹¤. ì•ì˜ ì˜ˆë¥¼ ì‚¬ìš©í•˜ì—¬ ë‹¤ìŒê³¼ ê°™ì´ `dataSource` êµ¬ì„±ì„ ë‹¤ì‹œ ì‘ì„±í•  ìˆ˜ ìˆë‹¤.

```java
@Configuration
@Profile("development")
public class StandaloneDataConfig {

    @Bean
    public DataSource dataSource() {
        return new EmbeddedDatabaseBuilder()
            .setType(EmbeddedDatabaseType.HSQL)
            .addScript("classpath:com/bank/config/sql/schema.sql")
            .addScript("classpath:com/bank/config/sql/test-data.sql")
            .build();
    }
}
```

```java
@Configuration
@Profile("production")
public class JndiDataConfig {

	@Bean(destroyMethod="")
	public DataSource dataSource() throws Exception {
		Context ctx = new InitialContext();
		return (DataSource) ctx.lookup("java:comp/env/jdbc/datasource");
	}
}
```

í”„ë¡œí•„ ë¬¸ìì—´ì—ëŠ” ê°„ë‹¨í•œ í”„ë¡œí•„ ì´ë¦„(ì˜ˆ: `production`) ë˜ëŠ” í”„ë¡œí•„ í‘œí˜„ì‹ì´ í¬í•¨ë  ìˆ˜ ìˆë‹¤. í”„ë¡œí•„ í‘œí˜„ì‹ì„ ì‚¬ìš©í•˜ë©´ ë” ë³µì¡í•œ í”„ë¡œí•„ ë…¼ë¦¬ë¥¼ í‘œí˜„í•  ìˆ˜ ìˆë‹¤(ì˜ˆ: `production & us-east`). í”„ë¡œí•„ í‘œí˜„ì‹ì—ì„œ ì§€ì›ë˜ëŠ” ì—°ì‚°ìëŠ” ë‹¤ìŒê³¼ ê°™ë‹¤.

- `!`: í”„ë¡œí•„ì˜ ë…¼ë¦¬ì  "not"

- `&`: í”„ë¡œí•„ì˜ ë…¼ë¦¬ì  "and"

- `|`: í”„ë¡œí•„ì˜ ë…¼ë¦¬ì  "or"

{% hint style="success" %}

ê´„í˜¸ë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šê³ ëŠ” `&`ì™€ `|`ë¥¼ í˜¼í•©í•  ìˆ˜ ì—†ë‹¤. ì˜ˆë¥¼ ë“¤ì–´, `Production & us-east | eu-central`ì€ ìœ íš¨í•œ í‘œí˜„ì‹ì´ ì•„ë‹ˆë‹¤. `Production & (us-east | eu-central)`ë¡œ í‘œí˜„í•´ì•¼ í•œë‹¤.

{% endhint %}

ì‚¬ìš©ì ì •ì˜ë¡œ ì‘ì„±ëœ ì–´ë…¸í…Œì´ì…˜ì„ ìƒì„±í•˜ê¸° ìœ„í•´ `@Profile`ì„ [ë©”íƒ€ ì–´ë…¸í…Œì´ì…˜](https://docs.spring.io/spring-framework/docs/current/reference/html/core.html#beans-meta-annotations) ìœ¼ë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤. ë‹¤ìŒ ì˜ˆì œëŠ” `@Profile("production")`ì— ëŒ€í•œ ì„ì‹œ êµì²´ë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ì‚¬ìš©ì ì •ì˜ `@Production` ì–´ë…¸í…Œì´ì…˜ì„ ì •ì˜í•œë‹¤.

```java
@Target(ElementType.TYPE)
@Retention(RetentionPolicy.RUNTIME)
@Profile("production")
public @interface Production {
}
```

{% hint style="success" %}

ğŸ’¡ `@Configuration` í´ë˜ìŠ¤ê°€ `@Profile`ë¡œ í‘œì‹œë˜ë©´ ì§€ì •ëœ í”„ë¡œí•„ ì¤‘ í•˜ë‚˜ ì´ìƒì´ í™œì„±í™”ë˜ì§€ ì•ŠëŠ” í•œ í•´ë‹¹ í´ë˜ìŠ¤ì™€ ê´€ë ¨ëœ ëª¨ë“  `@Bean` ë©”ì„œë“œ ë° `@Import` ì–´ë…¸í…Œì´ì…˜ì´ ë¬´ì‹œëœë‹¤. `@Component` ë˜ëŠ” `@Configuration` í´ë˜ìŠ¤ê°€ `@Profile({"p1", "p2"})`ë¡œ í‘œì‹œëœ ê²½ìš° í•´ë‹¹ í´ë˜ìŠ¤ëŠ” í”„ë¡œí•„ 'p1' ë˜ëŠ” 'p2'ê°€ í™œì„±í™”ë˜ì§€ ì•ŠëŠ” í•œ ë“±ë¡ë˜ê±°ë‚˜ ì²˜ë¦¬ë˜ì§€ ì•ŠëŠ”ë‹¤. ì£¼ì–´ì§„ í”„ë¡œí•„ì— NOT ì—°ì‚°ì(`!`)ê°€ ì ‘ë‘ì‚¬ë¡œ ë¶™ìœ¼ë©´ í”„ë¡œí•„ì´ í™œì„±í™”ë˜ì§€ ì•Šì€ ê²½ìš°ì—ë§Œ ì–´ë…¸í…Œì´ì…˜ì´ ë‹¬ë¦° ìš”ì†Œê°€ ë“±ë¡ëœë‹¤. ì˜ˆë¥¼ ë“¤ì–´ `@Profile({"p1", "!p2"})`ì´ ì£¼ì–´ì§€ë©´ í”„ë¡œí•„ 'p1'ì´ í™œì„±í™”ë˜ê±°ë‚˜ í”„ë¡œí•„ 'p2'ê°€ í™œì„±í™”ë˜ì§€ ì•Šìœ¼ë©´ ë“±ë¡ì´ ëœë‹¤.

{% endhint %}

`@Profile`ì€ ë‹¤ìŒ ì˜ˆì œì™€ ê°™ì´ êµ¬ì„± í´ë˜ìŠ¤ì˜ íŠ¹ì • ë¹ˆì„ í•˜ë‚˜ë§Œ í¬í•¨í•˜ë„ë¡ ë©”ì„œë“œ ìˆ˜ì¤€ì—ì„œ ì„ ì–¸í•  ìˆ˜ë„ ìˆë‹¤.

```java
@Configuration
public class AppConfig {

    @Bean("dataSource")
    @Profile("development") 
    public DataSource standaloneDataSource() {
        return new EmbeddedDatabaseBuilder()
            .setType(EmbeddedDatabaseType.HSQL)
            .addScript("classpath:com/bank/config/sql/schema.sql")
            .addScript("classpath:com/bank/config/sql/test-data.sql")
            .build();
    }

    @Bean("dataSource")
    @Profile("production") 
    public DataSource jndiDataSource() throws Exception {
        Context ctx = new InitialContext();
        return (DataSource) ctx.lookup("java:comp/env/jdbc/datasource");
    }
}
```

`standaloneDataSource` ë©”ì„œë“œëŠ” `development` í”„ë¡œí•„ì—ì„œë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.

`jndiDataSource` ë©”ì†Œë“œëŠ” `production` í”„ë¡œí•„ì—ì„œë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.

{% hint style="success" %}

`@Bean` ë©”ì†Œë“œì— `@Profile`ì„ ì‚¬ìš©í•˜ë©´ ë‹¤ìŒê³¼ ê°™ì€ íŠ¹ë³„í•œ ì‹œë‚˜ë¦¬ì˜¤ê°€ ì ìš©ë  ìˆ˜ ìˆë‹¤. ë™ì¼í•œ Java ë©”ì†Œë“œ ì´ë¦„ì˜ ì˜¤ë²„ë¡œë“œëœ `@Bean` ë©”ì†Œë“œì˜ ê²½ìš°(ìƒì„±ì ì˜¤ë²„ë¡œë”©ê³¼ ìœ ì‚¬), `@Profile` ì¡°ê±´ì€ ì˜¤ë²„ë¡œë“œëœ ëª¨ë“  ë©”ì†Œë“œì— ì¼ê´€ë˜ê²Œ ì„ ì–¸ë˜ì–´ì•¼ í•œë‹¤. ì¡°ê±´ì´ ì¼ì¹˜í•˜ì§€ ì•Šìœ¼ë©´ ì˜¤ë²„ë¡œë“œëœ ë©”ì„œë“œ ì¤‘ ì²« ë²ˆì§¸ ì„ ì–¸ì˜ ì¡°ê±´ë§Œ ì¤‘ìš”í•˜ë‹¤. ë”°ë¼ì„œ `@Profile`ì€ íŠ¹ì • ì¸ìˆ˜ ì„œëª…ì´ ìˆëŠ” ì˜¤ë²„ë¡œë“œëœ ë©”ì„œë“œë¥¼ ì„ íƒí•˜ëŠ” ë° ì‚¬ìš©í•  ìˆ˜ëŠ” ì—†ë‹¤. ë™ì¼í•œ ë¹ˆì— ëŒ€í•œ ëª¨ë“  íŒ©í† ë¦¬ ë©”ì„œë“œ ê°„ì˜ ì—°ê²°ì€ ìƒì„± ì‹œ Springì˜ ìƒì„±ì ì—°ê²° ì•Œê³ ë¦¬ì¦˜ì„ ë”°ë¥¸ë‹¤.

í”„ë¡œí•„ ì¡°ê±´ì´ ë‹¤ë¥¸ ëŒ€ì²´ Beanì„ ì •ì˜í•˜ë ¤ë©´ ì•ì˜ ì˜ˆì™€ ê°™ì´ `@Bean` ì´ë¦„ ì†ì„±ì„ ì‚¬ìš©í•˜ì—¬ ë™ì¼í•œ Bean ì´ë¦„ì„ ê°€ë¦¬í‚¤ëŠ” ê³ ìœ í•œ Java ë©”ì†Œë“œ ì´ë¦„ì„ ì‚¬ìš©í•˜ë¼.

{% endhint %}

### í”„ë¡œí•„ í™œì„±í™”

ì´ì œ êµ¬ì„±ì„ ì—…ë°ì´íŠ¸í–ˆìœ¼ë¯€ë¡œ ì—¬ì „íˆ ì–´ë–¤ í”„ë¡œí•„ì´ í™œì„±í™”ë˜ì–´ ìˆëŠ”ì§€ Springì— ì§€ì‹œí•´ì•¼ í•œë‹¤. ì§€ê¸ˆ ìƒ˜í”Œ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ì‹œì‘í–ˆë‹¤ë©´ ì»¨í…Œì´ë„ˆê°€ `dataSource`ë¼ëŠ” ì´ë¦„ì˜ Spring ë¹ˆì„ ì°¾ì„ ìˆ˜ ì—†ì—ˆê¸° ë•Œë¬¸ì— `NoSuchBeanDefinitionException`ì´ ì—ëŸ¬ê°€ ë‚˜ì˜¨ ê²ƒì„ ë³¼ ìˆ˜ ìˆë‹¤.

í”„ë¡œí•„ í™œì„±í™”ëŠ” ì—¬ëŸ¬ ê°€ì§€ ë°©ë²•ìœ¼ë¡œ ìˆ˜í–‰í•  ìˆ˜ ìˆì§€ë§Œ ê°€ì¥ ê°„ë‹¨í•œ ë°©ë²•ì€ `ApplicationContext`ë¥¼ í†µí•´ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” `Environment` APIì— ëŒ€í•´ í”„ë¡œê·¸ë˜ë° ë°©ì‹ìœ¼ë¡œ ìˆ˜í–‰í•˜ëŠ” ê²ƒì´ë‹¤. ë‹¤ìŒ ì˜ˆì—ì„œëŠ” ê·¸ëŸ° ë°©ë²•ì„ ë³´ì—¬ì¤€ë‹¤.

```java
AnnotationConfigApplicationContext ctx = new AnnotationConfigApplicationContext();
ctx.getEnvironment().setActiveProfiles("development");
ctx.register(SomeConfig.class, StandaloneDataConfig.class, JndiDataConfig.class);
ctx.refresh();
```

ë˜í•œ ì‹œìŠ¤í…œ í™˜ê²½ ë³€ìˆ˜, JVM ì‹œìŠ¤í…œ ì†ì„±, `web.xml`ì˜ ì„œë¸”ë¦¿ ì»¨í…ìŠ¤íŠ¸ ë§¤ê°œë³€ìˆ˜ ë˜ëŠ” JNDIì˜ í•­ëª©ìœ¼ë¡œ ì§€ì •í•  ìˆ˜ ìˆëŠ” `spring.profiles.active` propertyë¥¼ í†µí•´ ì„ ì–¸ì ìœ¼ë¡œ í”„ë¡œí•„ì„ í™œì„±í™”í•  ìˆ˜ë„ ìˆë‹¤([`PropertySource Abstraction`](https://docs.spring.io/spring-framework/docs/current/reference/html/core.html#beans-property-source-abstraction) ì„ ì°¸ì¡°). í†µí•© í…ŒìŠ¤íŠ¸ì—ì„œ í™œì„± í”„ë¡œí•„ì€ `spring-test` ëª¨ë“ˆì˜ `@ActiveProfiles` ì–´ë…¸í…Œì´ì…˜ì„ ì‚¬ìš©í•˜ì—¬ ì„ ì–¸í•  ìˆ˜ ìˆë‹¤([í™˜ê²½ í”„ë¡œí•„ì´ ìˆëŠ” ì»¨í…ìŠ¤íŠ¸ êµ¬ì„±](https://docs.spring.io/spring-framework/docs/current/reference/html/testing.html#testcontext-ctx-management-env-profiles) ì°¸ì¡°).

í”„ë¡œí•„ì€ "ë‘˜ ì¤‘ í•˜ë‚˜"ê°€ ì•„ë‹ˆë‹¤. í•œ ë²ˆì— ì—¬ëŸ¬ í”„ë¡œí•„ì„ í™œì„±í™”í•  ìˆ˜ ìˆë‹¤. í”„ë¡œê·¸ë˜ë° ë°©ì‹ìœ¼ë¡œ `Stringâ€¦` varargsë¥¼ í—ˆìš©í•˜ëŠ” `setActiveProfiles()` ë©”ì„œë“œì— ì—¬ëŸ¬ í”„ë¡œí•„ ì´ë¦„ì„ ì œê³µí•  ìˆ˜ ìˆë‹¤. ë‹¤ìŒ ì˜ˆì—ì„œëŠ” ì—¬ëŸ¬ í”„ë¡œí•„ì„ í™œì„±í™”í•œë‹¤.

```java
ctx.getEnvironment().setActiveProfiles("profile1", "profile2");
```

ì„ ì–¸ì ìœ¼ë¡œ spring.profiles.activeëŠ” ë‹¤ìŒ ì˜ˆì œì™€ ê°™ì´ ì‰¼í‘œë¡œ êµ¬ë¶„ëœ í”„ë¡œí•„ ì´ë¦„ ëª©ë¡ì„ í—ˆìš©í•  ìˆ˜ ìˆë‹¤.

```
    -Dspring.profiles.active="profile1,profile2"
```

### ë””í´íŠ¸ í”„ë¡œí•„(Default Profile)

ê¸°ë³¸ í”„ë¡œí•„ì€ ê¸°ë³¸ì ìœ¼ë¡œ í™œì„±í™”ëœ í”„ë¡œí•„ì„ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤. ë‹¤ìŒ ì˜ˆë¥¼ ë´ë¼.

```java
@Configuration
@Profile("default")
public class DefaultDataConfig {

    @Bean
    public DataSource dataSource() {
        return new EmbeddedDatabaseBuilder()
            .setType(EmbeddedDatabaseType.HSQL)
            .addScript("classpath:com/bank/config/sql/schema.sql")
            .build();
    }
}
```

í™œì„± í”„ë¡œí•„ì´ ì—†ìœ¼ë©´ `dataSource`ê°€ ìƒì„±ëœë‹¤. ì´ê²ƒì€ í•˜ë‚˜ ì´ìƒì˜ ë¹ˆì— ëŒ€í•œ ê¸°ë³¸ ì •ì˜ë¥¼ ì œê³µí•˜ëŠ” ë°©ë²•ìœ¼ë¡œ ë³¼ ìˆ˜ ìˆë‹¤. í”„ë¡œí•„ì´ í™œì„±í™”ë˜ì–´ ìˆìœ¼ë©´ ê¸°ë³¸ í”„ë¡œí•„ì´ ì ìš©ë˜ì§€ ì•ŠëŠ”ë‹¤.

`Environment`ì—ì„œ `setDefaultProfiles()`ë¥¼ ì‚¬ìš©í•˜ê±°ë‚˜ ì„ ì–¸ì ìœ¼ë¡œ `spring.profiles.default` ì†ì„±ì„ ì‚¬ìš©í•˜ì—¬ ê¸°ë³¸ í”„ë¡œí•„ì˜ ì´ë¦„ì„ ë³€ê²½í•  ìˆ˜ ìˆë‹¤.

## 1.13.2. `PropertySource` Abstraction

Springì˜ `Environment` ì¶”ìƒí™”ëŠ” property ì†ŒìŠ¤ì˜ êµ¬ì„± ê°€ëŠ¥í•œ ê³„ì¸µ êµ¬ì¡°ì— ëŒ€í•œ ê²€ìƒ‰ ì‘ì—…ì„ ì œê³µí•œë‹¤. ë‹¤ìŒ ëª©ë¡ì„ ë³´ì.

```java
ApplicationContext ctx = new GenericApplicationContext();
Environment env = ctx.getEnvironment();
boolean containsMyProperty = env.containsProperty("my-property");
System.out.println("Does my environment contain the 'my-property' property? " + containsMyProperty);
```

ì•ì˜ ì¸ìš©ì—ì„œ í˜„ì¬ í™˜ê²½ì— ëŒ€í•´ `my-property` í”„ë¡œí¼í‹°ê°€ ì •ì˜ë˜ì–´ ìˆëŠ”ì§€ ì—¬ë¶€ë¥¼ Springì— ë¬»ëŠ” ìƒìœ„ ìˆ˜ì¤€ ë°©ë²•ì„ ë³¼ ìˆ˜ ìˆë‹¤. ì´ ì§ˆë¬¸ì— ë‹µí•˜ê¸° ìœ„í•´ `Environment` ê°ì²´ëŠ” [`PropertySource`](https://docs.spring.io/spring-framework/docs/5.3.23/javadoc-api/org/springframework/core/env/PropertySource.html) ê°ì²´ ì§‘í•©ì— ëŒ€í•´ ê²€ìƒ‰ì„ ìˆ˜í–‰í•œë‹¤. `PropertySource`ëŠ” í‚¤-ê°’ ìŒì˜ ëª¨ë“  ì†ŒìŠ¤ì— ëŒ€í•œ ê°„ë‹¨í•œ ì¶”ìƒí™”ì´ë©° Springì˜ [`StandardEnvironment`](https://docs.spring.io/spring-framework/docs/5.3.23/javadoc-api/org/springframework/core/env/StandardEnvironment.html) ëŠ” ë‘ ê°œì˜ PropertySource ê°ì²´ë¡œ êµ¬ì„±ëœë‹¤. í•˜ë‚˜ëŠ” JVM ì‹œìŠ¤í…œ ì†ì„± ì§‘í•©(`System.getProperties()`)ì„ ë‚˜íƒ€ë‚´ê³  ë‹¤ë¥¸ í•˜ë‚˜ëŠ” ì‹œìŠ¤í…œ í™˜ê²½ ë³€ìˆ˜ ì§‘í•©(`System.getenv()`)ì„ ë‚˜íƒ€ë‚¸ë‹¤.

êµ¬ì²´ì ìœ¼ë¡œ, `StandardEnvironment`ë¥¼ ì‚¬ìš©í•  ë•Œ `env.containsProperty("my-property")` í˜¸ì¶œì€ ëŸ°íƒ€ì„ì— `my-property` ì‹œìŠ¤í…œ ì†ì„± ë˜ëŠ” `my-property` í™˜ê²½ ë³€ìˆ˜ê°€ ìˆëŠ” ê²½ìš° trueë¥¼ ë°˜í™˜í•œë‹¤.

{% hint style="success" %}

ğŸ’¡ ìˆ˜í–‰ëœ ê²€ìƒ‰ì€ ê³„ì¸µì ì´ë‹¤. ê¸°ë³¸ì ìœ¼ë¡œ ì‹œìŠ¤í…œ ì†ì„±ì€ í™˜ê²½ ë³€ìˆ˜ë³´ë‹¤ ìš°ì„ í•œë‹¤. ë”°ë¼ì„œ `env.getProperty("my-property")`ë¥¼ í˜¸ì¶œí•˜ëŠ” ë™ì•ˆ `my-property` ì†ì„±ì´ ë‘ ìœ„ì¹˜ì— ëª¨ë‘ ì„¤ì •ë˜ë©´ ì‹œìŠ¤í…œ ì†ì„± ê°’ì´ "ìŠ¹ë¦¬"í•˜ê³  ë°˜í™˜ëœë‹¤. ì†ì„± ê°’ì€ ë³‘í•©ë˜ì§€ ì•Šê³  ìƒìœ„ í•­ëª©ì— ì˜í•´ ì™„ì „íˆ ë¬´ì‹œëœë‹¤.

ì¼ë°˜ì ì¸ StandardServletEnvironmentì˜ ê²½ìš° ì „ì²´ ê³„ì¸µ êµ¬ì¡°ëŠ” ë‹¤ìŒê³¼ ê°™ìœ¼ë©° ìš°ì„  ìˆœìœ„ê°€ ê°€ì¥ ë†’ì€ í•­ëª©ì´ ë§¨ ìœ„ì— ìˆë‹¤.

1. ServletConfig ë§¤ê°œë³€ìˆ˜(í•´ë‹¹ë˜ëŠ” ê²½ìš° ì˜ˆ: `DispatcherServlet` ì»¨í…ìŠ¤íŠ¸ì˜ ê²½ìš°)

2. ServletContext ë§¤ê°œë³€ìˆ˜(web.xml ì»¨í…ìŠ¤íŠ¸ ë§¤ê°œë³€ìˆ˜ í•­ëª©)

3. JNDI í™˜ê²½ ë³€ìˆ˜(`java:comp/env/` í•­ëª©)

4. JVM ì‹œìŠ¤í…œ ì†ì„±(`-D` ëª…ë ¹ì¤„ ì¸ìˆ˜)

5. JVM ì‹œìŠ¤í…œ í™˜ê²½(ìš´ì˜ ì²´ì œ í™˜ê²½ ë³€ìˆ˜)

{% endhint %}

ê°€ì¥ ì¤‘ìš”í•œ ê²ƒì€ ì „ì²´ ë©”ì»¤ë‹ˆì¦˜ì„ êµ¬ì„±í•  ìˆ˜ ìˆë‹¤ëŠ” ê²ƒì´ë‹¤. ì´ ê²€ìƒ‰ì— í†µí•©í•˜ë ¤ëŠ” ì†ì„±ì˜ ì‚¬ìš©ì ì •ì˜ ì†ŒìŠ¤ê°€ ìˆì„ ìˆ˜ ìˆë‹¤. ê·¸ë ‡ê²Œ í•˜ë ¤ë©´ ê³ ìœ í•œ `PropertySource`ë¥¼ êµ¬í˜„ ë° ì¸ìŠ¤í„´ìŠ¤í™”í•˜ê³  í˜„ì¬ `Environment`ì˜ `PropertySource` ì§‘í•©ì— ì¶”ê°€í•œë‹¤. ë‹¤ìŒ ì˜ˆì—ì„œëŠ” ê·¸ë ‡ê²Œ í•˜ëŠ” ë°©ë²•ì„ ë³´ì—¬ì¤€ë‹¤.

```java
ConfigurableApplicationContext ctx = new GenericApplicationContext();
MutablePropertySources sources = ctx.getEnvironment().getPropertySources();
sources.addFirst(new MyPropertySource());
```

ì•ì˜ ì½”ë“œì—ì„œ `MyPropertySource`ëŠ” ê²€ìƒ‰ì—ì„œ ê°€ì¥ ë†’ì€ ìš°ì„  ìˆœìœ„ë¡œ ì¶”ê°€ë˜ì—ˆë‹¤. `my-property` ì†ì„±ì´ í¬í•¨ë˜ì–´ ìˆìœ¼ë©´ ë‹¤ë¥¸ `PropertySource`ì˜ `my-property` ì†ì„±ì„ ìœ„í•´ ì†ì„±ì´ ê°ì§€ë˜ê³  ë°˜í™˜ëœë‹¤. [`MutablePropertySources`](https://docs.spring.io/spring-framework/docs/5.3.23/javadoc-api/org/springframework/core/env/MutablePropertySources.html) APIëŠ” ì†ì„± ì†ŒìŠ¤ ì§‘í•©ì„ ì •ë°€í•˜ê²Œ ì¡°ì‘í•  ìˆ˜ ìˆëŠ” ì—¬ëŸ¬ ë©”ì„œë“œë¥¼ ì œê³µí•œë‹¤.

## 1.13.3. Using `@PropertySource`

[`@PropertySource`](https://docs.spring.io/spring-framework/docs/5.3.23/javadoc-api/org/springframework/context/annotation/PropertySource.html) ì–´ë…¸í…Œì´ì…˜ì€ Springì˜ `Environment`ì— `PropertySource`ë¥¼ ì¶”ê°€í•˜ê¸° ìœ„í•œ í¸ë¦¬í•˜ê³  ì„ ì–¸ì ì¸ ë©”ì»¤ë‹ˆì¦˜ì„ ì œê³µí•œë‹¤.

í‚¤-ê°’ ìŒ `testbean.name=myTestBean`ì„ í¬í•¨í•˜ëŠ” `app.properties`ë¼ëŠ” íŒŒì¼ì´ ì£¼ì–´ì§€ë©´ ë‹¤ìŒ `@Configuration` í´ë˜ìŠ¤ëŠ” `testBean.getName()`ì— ëŒ€í•œ í˜¸ì¶œì´ `myTestBean`ì„ ë°˜í™˜í•˜ëŠ” ë°©ì‹ìœ¼ë¡œ `@PropertySource`ë¥¼ ì‚¬ìš©í•œë‹¤.

```java
@Configuration
@PropertySource("classpath:/com/myco/app.properties")
public class AppConfig {

    @Autowired
    Environment env;

    @Bean
    public TestBean testBean() {
        TestBean testBean = new TestBean();
        testBean.setName(env.getProperty("testbean.name"));
        return testBean;
    }
}
```

`@PropertySource` ë¦¬ì†ŒìŠ¤ ìœ„ì¹˜ì— ìˆëŠ” ëª¨ë“  `${â€¦}` placeholderëŠ” ë‹¤ìŒ ì˜ˆì œì™€ ê°™ì´ ì´ë¯¸ í™˜ê²½ì— ë“±ë¡ëœ ì†ì„± ì†ŒìŠ¤ ì§‘í•©ì— ëŒ€í•´ í™•ì¸ëœë‹¤.

```java
@Configuration
@PropertySource("classpath:/com/${my.placeholder:default/path}/app.properties")
public class AppConfig {

    @Autowired
    Environment env;

    @Bean
    public TestBean testBean() {
        TestBean testBean = new TestBean();
        testBean.setName(env.getProperty("testbean.name"));
        return testBean;
    }
}
```

`my.placeholder`ê°€ ì´ë¯¸ ë“±ë¡ëœ ì†ì„± ì†ŒìŠ¤ ì¤‘ í•˜ë‚˜(ì˜ˆ: ì‹œìŠ¤í…œ ì†ì„± ë˜ëŠ” í™˜ê²½ ë³€ìˆ˜)ì— ìˆë‹¤ê³  ê°€ì •í•˜ë©´ placeholderëŠ” í•´ë‹¹ ê°’ìœ¼ë¡œ í™•ì¸ëœë‹¤. ê·¸ë ‡ì§€ ì•Šì€ ê²½ìš° `default/path`ê°€ ê¸°ë³¸ê°’ìœ¼ë¡œ ì‚¬ìš©ëœë‹¤. ê¸°ë³¸ê°’ì´ ì§€ì •ë˜ì§€ ì•Šê³  ì†ì„±ì„ í™•ì¸í•  ìˆ˜ ì—†ìœ¼ë©´ `IllegalArgumentException`ì´ ë°œìƒí•œë‹¤.

## 1.13.4. Placeholder Resolution in Statements

ì—­ì‚¬ì ìœ¼ë¡œ ìš”ì†Œì˜ placeholder ê°’ì€ JVM ì‹œìŠ¤í…œ ì†ì„± ë˜ëŠ” í™˜ê²½ ë³€ìˆ˜ì— ëŒ€í•´ì„œë§Œ í™•ì¸í•  ìˆ˜ ìˆì—ˆë‹¤. ë” ì´ìƒ ê·¸ë ‡ì§€ ì•Šë‹¤. `Environment` ì¶”ìƒí™”ëŠ” ì»¨í…Œì´ë„ˆ ì „ì²´ì— í†µí•©ë˜ì–´ ìˆìœ¼ë¯€ë¡œ ì´ë¥¼ í†µí•´ placeholderì˜ í™•ì¸ì„ ì‰½ê²Œ ë¼ìš°íŒ…í•  ìˆ˜ ìˆë‹¤. ì¦‰, ì›í•˜ëŠ” ë°©ì‹ìœ¼ë¡œ í•´ê²° í”„ë¡œì„¸ìŠ¤ë¥¼ êµ¬ì„±í•  ìˆ˜ ìˆë‹¤. ì‹œìŠ¤í…œ ì†ì„± ë° í™˜ê²½ ë³€ìˆ˜ë¥¼ í†µí•œ ê²€ìƒ‰ ìš°ì„  ìˆœìœ„ë¥¼ ë³€ê²½í•˜ê±°ë‚˜ ì™„ì „íˆ ì œê±°í•  ìˆ˜ ìˆë‹¤. í•„ìš”ì— ë”°ë¼ ê³ ìœ í•œ ì†ì„± ì†ŒìŠ¤ë¥¼ ë¯¹ìŠ¤ì— ì¶”ê°€í•  ìˆ˜ë„ ìˆë‹¤.

êµ¬ì²´ì ìœ¼ë¡œ ë‹¤ìŒ ëª…ë ¹ë¬¸ì€ `Environment`ì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” í•œ `customer` ì†ì„±ì´ ì •ì˜ëœ ìœ„ì¹˜ì— ê´€ê³„ì—†ì´ ì‘ë™í•œë‹¤.

```
<beans>
    <import resource="com/bank/service/${customer}-config.xml"/>
</beans>
```

# 1.14. Registering a `LoadTimeWeaver`

`LoadTimeWeaver`ëŠ” í´ë˜ìŠ¤ê°€ JVM(Java Virtual Machine)ì— ë¡œë“œë  ë•Œ í´ë˜ìŠ¤ë¥¼ ë™ì ìœ¼ë¡œ ë³€í™˜í•˜ê¸° ìœ„í•´ Springì—ì„œ ì‚¬ìš©ëœë‹¤.

ë¡œë“œ íƒ€ì„ ìœ„ë¹™ì„ í™œì„±í™”í•˜ë ¤ë©´ ë‹¤ìŒ ì˜ˆì œì™€ ê°™ì´ `@Configuration` í´ë˜ìŠ¤ ì¤‘ í•˜ë‚˜ì— `@EnableLoadTimeWeaving`ì„ ì¶”ê°€í•˜ë©´ ëœë‹¤.

```java
@Configuration
@EnableLoadTimeWeaving
public class AppConfig {
}
```
